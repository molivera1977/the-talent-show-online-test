/* ---------- DATA (exact wording from review banks) ---------- */
window.VOCAB_BANK = [
  {
    "q": "showing kindness and good manners toward others",
    "choices": ["carefully","individual","describe","respectful"],
    "answer": 3
  },
  {
    "q": "<strong>uncomfortably</strong> — Which definition matches this word?",
    "choices": [
      "in a way that makes you feel uneasy or not relaxed",
      "responsible for your own actions and choices",
      "to stop someone while they are talking or doing something",
      "to think carefully about something before deciding"
    ],
    "answer": 0
  },
  {
    "q": "speaking in a short or unfriendly way",
    "choices": ["stand up","describe","uncomfortably","curt"],
    "answer": 3
  },
  {
    "q": "<strong>worry</strong> — Which definition matches this word?",
    "choices": [
      "the act of holding something tightly",
      "to feel nervous or uneasy about something that might happen",
      "a set of events or circumstances that happen at one time",
      "in a way that shows great need or desire"
    ],
    "answer": 1
  },
  {
    "q": "something that happens suddenly and is unexpected",
    "choices": ["inspiration","resentful","surprise","describe"],
    "answer": 2
  },
  {
    "q": "<strong>besides</strong> — Which definition matches this word?",
    "choices": [
      "to talk about something using details or words",
      "feeling upset or angry because something seems unfair",
      "in addition to something else; also",
      "showing kindness and good manners toward others"
    ],
    "answer": 2
  },
  {
    "q": "a set of events or circumstances that happen at one time",
    "choices": ["situation","desperately","inspiration","uncomfortably"],
    "answer": 0
  },
  {
    "q": "<strong>accountable</strong> — Which definition matches this word?",
    "choices": [
      "to stop someone while they are talking or doing something",
      "responsible for your own actions and choices",
      "a single person or thing, not part of a group",
      "speaking in a short or unfriendly way"
    ],
    "answer": 1
  },
  {
    "q": "to give someone ideas or suggestions about what to do",
    "choices": ["stand up","respectful","interrupt","advise"],
    "answer": 3
  },
  {
    "q": "<strong>take care</strong> — Which definition matches this word?",
    "choices": [
      "to look after someone or something",
      "to feel nervous or uneasy about something that might happen",
      "in a way that shows great need or desire",
      "something that gives you an idea or the desire to do something"
    ],
    "answer": 0
  },
  {
    "q": "a single person or thing, not part of a group",
    "choices": ["advise","grip","individual","stand up"],
    "answer": 2
  },
  {
    "q": "<strong>grip</strong> — Which definition matches this word?",
    "choices": [
      "the act of holding something tightly",
      "paused before saying or doing something because you are unsure",
      "something that happens suddenly and is unexpected",
      "in a way that shows great need or desire"
    ],
    "answer": 0
  },
  {
    "q": "to be brave and speak up for what you believe or want",
    "choices": ["situation","surprise","stand up","describe"],
    "answer": 2
  },
  {
    "q": "<strong>self-esteem</strong> — Which definition matches this word?",
    "choices": [
      "to feel nervous or uneasy about something that might happen",
      "to look after someone or something",
      "in a way that shows you are paying close attention",
      "the way you feel about yourself; confidence or pride in yourself"
    ],
    "answer": 3
  },
  {
    "q": "feeling very embarrassed or ashamed",
    "choices": ["besides","stand up","worry","humiliated"],
    "answer": 3
  },
  {
    "q": "<strong>hesitated</strong> — Which definition matches this word?",
    "choices": [
      "showing kindness and good manners toward others",
      "paused before saying or doing something because you are unsure",
      "a set of events or circumstances that happen at one time",
      "to be brave and speak up for what you believe or want"
    ],
    "answer": 1
  },
  {
    "q": "to stop someone while they are talking or doing something",
    "choices": ["interrupt","respectful","advise","resentful"],
    "answer": 0
  },
  {
    "q": "<strong>describe</strong> — Which definition matches this word?",
    "choices": [
      "paused before saying or doing something because you are unsure",
      "to be brave and speak up for what you believe or want",
      "to talk about something using details or words",
      "showing kindness and good manners toward others"
    ],
    "answer": 2
  },
  {
    "q": "a set of movements or actions done in a certain order",
    "choices": ["worry","describe","self-esteem","routine"],
    "answer": 3
  },
  {
    "q": "<strong>carefully</strong> — Which definition matches this word?",
    "choices": [
      "feeling upset or angry because something seems unfair",
      "in a way that shows you are paying close attention",
      "something that happens suddenly and is unexpected",
      "a set of events or circumstances that happen at one time"
    ],
    "answer": 1
  },
  {
    "q": "something that gives you an idea or the desire to do something",
    "choices": ["besides","inspiration","desperately","humiliated"],
    "answer": 1
  },
  {
    "q": "<strong>desperately</strong> — Which definition matches this word?",
    "choices": [
      "in a way that shows great need or desire",
      "a set of events or circumstances that happen at one time",
      "something that gives you an idea or the desire to do something",
      "something that happens suddenly and is unexpected"
    ],
    "answer": 0
  },
  {
    "q": "to think carefully about something before deciding",
    "choices": ["interrupt","consider","routine","curt"],
    "answer": 1
  },
  {
    "q": "<strong>resentful</strong> — Which definition matches this word?",
    "choices": [
      "paused before saying or doing something because you are unsure",
      "in a way that shows great need or desire",
      "feeling upset or angry because something seems unfair",
      "a set of events or circumstances that happen at one time"
    ],
    "answer": 2
  }
];

window.COMP_BANK = [
  {
    "q": "When Maura first told Tina about the talent show, what was Maura most excited about?",
    "choices": [
      "She wanted to work with her best friend on an act.",
      "She wanted to perform a juggling act her brother had taught her.",
      "She hoped Tina would choose a song for them to sing.",
      "She was planning to watch other kids perform."
    ],
    "answer": 1
  },
  {
    "q": "What can you infer when Maura’s “grip on [her] books became uncomfortably tight”?",
    "choices": [
      "She was nervous about talking to Tina.",
      "She didn’t want to share her act idea with Tina.",
      "She was scared to perform on stage.",
      "She thought Tina’s idea sounded better."
    ],
    "answer": 1
  },
  {
    "q": "Why did Maura hesitate before talking about her idea?",
    "choices": [
      "She didn’t think Tina would understand.",
      "She forgot what her idea was.",
      "She wasn’t sure how to tell Tina she wanted to perform alone.",
      "She wanted to hear Tina’s plan first."
    ],
    "answer": 2
  },
  {
    "q": "What does the sentence “Tina always takes charge, I don’t speak up, and then I end up feeling resentful” show about Maura?",
    "choices": [
      "She enjoys letting Tina make decisions.",
      "She struggles to express her own opinions to her friend.",
      "She prefers to avoid arguments.",
      "She wants to stop being friends with Tina."
    ],
    "answer": 1
  },
  {
    "q": "What does the word “desperately” in the sentence “I desperately wanted to win” tell you about Maura’s feelings?",
    "choices": [
      "She didn’t care much about winning.",
      "She wanted to perform with Tina.",
      "She was afraid to try something new.",
      "She really, really wanted to win on her own."
    ],
    "answer": 3
  },
  {
    "q": "What inspired Tina’s idea for their act?",
    "choices": [
      "The TV show You’ve Got Talent.",
      "Maura’s juggling lessons.",
      "Her grandmother’s advice.",
      "A book she read about teamwork."
    ],
    "answer": 0
  },
  {
    "q": "When Tina says, “We don’t want to be humiliated, right?” what can you infer about her?",
    "choices": [
      "She doesn’t think Maura’s idea is good.",
      "She’s worried about looking foolish in front of others.",
      "She doesn’t like to perform on stage.",
      "She wants Maura to feel embarrassed."
    ],
    "answer": 1
  },
  {
    "q": "What lesson does Grandmother try to teach Maura when she says, “You’re still accountable for your own actions”?",
    "choices": [
      "It’s better to let others decide for you.",
      "You must take responsibility for what you say and do.",
      "You shouldn’t argue with your friends.",
      "It’s wrong to compete against others."
    ],
    "answer": 1
  },
  {
    "q": "How does Maura’s grandmother help her make a decision?",
    "choices": [
      "She tells Maura to do whatever Tina wants.",
      "She advises Maura to be honest and stand up for herself.",
      "She tells Maura to quit the talent show.",
      "She offers to call Tina for her."
    ],
    "answer": 1
  },
  {
    "q": "When Grandmother says, “It will be good for your self-esteem,” what does she mean?",
    "choices": [
      "It will help Maura become more confident.",
      "It will make Tina feel proud of her.",
      "It will stop Maura from being nervous.",
      "It will make the juggling act perfect."
    ],
    "answer": 0
  },
  {
    "q": "What does Maura’s action of taking “12 deep breaths” before calling Tina show?",
    "choices": [
      "She was excited to share her idea.",
      "She didn’t care about Tina’s feelings.",
      "She was nervous but determined to speak up.",
      "She was practicing her act."
    ],
    "answer": 2
  },
  {
    "q": "How did Tina react when Maura told her she wanted to do her own act?",
    "choices": [
      "She laughed and agreed right away.",
      "She sounded short and upset on the phone.",
      "She congratulated Maura.",
      "She said she didn’t want to be friends anymore."
    ],
    "answer": 1
  },
  {
    "q": "What does Maura mean when she says, “I spent all night worrying she would be mad at me”?",
    "choices": [
      "She didn’t care about Tina’s feelings.",
      "She was afraid her decision might hurt her friend’s feelings.",
      "She regretted doing her act alone.",
      "She wanted Tina to fail."
    ],
    "answer": 1
  },
  {
    "q": "Which quote best supports the idea that Maura learned to stand up for herself?",
    "choices": [
      "“I shouted to my best friend.”",
      "“Tina always takes charge.”",
      "“I thought about this. ‘So what should I do?’ I asked.”",
      "“I guess standing up for myself did pay off.”"
    ],
    "answer": 3
  },
  {
    "q": "What can the reader conclude about Tina at the end of the story?",
    "choices": [
      "She was no longer Maura’s friend.",
      "She was still upset with Maura.",
      "She respected Maura’s decision and moved on.",
      "She decided not to perform in the show."
    ],
    "answer": 2
  },
  {
    "q": "What is the main idea of “The Talent Show”?",
    "choices": [
      "Two friends compete in a talent show to win first place.",
      "A girl learns to speak up for herself and take responsibility for her actions.",
      "A grandmother helps her granddaughter prepare for a big performance.",
      "Two classmates discover they have the same talent."
    ],
    "answer": 1
  },
  {
    "q": "Which sentence from the story best shows Maura’s problem?",
    "choices": [
      "“Tina ran over to the bulletin board and read the poster.”",
      "“The problem is Tina always takes charge, I don’t speak up.”",
      "“My brother had been teaching me juggling.”",
      "“It’ll be fun,” Tina said."
    ],
    "answer": 1
  },
  {
    "q": "Which quote best supports the idea that Maura’s grandmother gives wise advice?",
    "choices": [
      "“Cat got your tongue?”",
      "“It wouldn’t hurt to let Tina know what you want.”",
      "“You should drop out of the show.”",
      "“Don’t tell Tina how you feel.”"
    ],
    "answer": 1
  },
  {
    "q": "What change happens in Maura from the beginning to the end of the story?",
    "choices": [
      "She becomes afraid to talk to Tina.",
      "She decides teamwork is more important than honesty.",
      "She goes from quiet and unsure to confident and honest.",
      "She learns juggling is too hard."
    ],
    "answer": 2
  },
  {
    "q": "What theme is best shown through Maura’s experience?",
    "choices": [
      "It’s important to be honest and stand up for what you believe.",
      "Friends should always agree on everything.",
      "Winning is more important than friendship.",
      "It’s better to let others make choices for you."
    ],
    "answer": 0
  }
];

window.CLOZE_BANK = [
  {"q":"Maura tightened her _______ on her books when Tina said, “What’s our act going to be?”","choices":["grip","handle","touch"],"answer":0},
  {"q":"The talent show allowed each student to perform as an _______ or in a small group.","choices":["partner","helper","individual"],"answer":2},
  {"q":"Maura held her books _______ as she thought about what to say to Tina.","choices":["comfortably","loosely","uncomfortably"],"answer":2},
  {"q":"Maura _______ before she told Tina she already had an idea for her act.","choices":["rushed","hesitated","whispered"],"answer":1},
  {"q":"Tina liked to talk so much that she would sometimes _______ Maura mid-sentence.","choices":["encourage","listen","interrupt"],"answer":2},
  {"q":"Grandma reminded Maura to _______ of her responsibilities and be honest with her friend.","choices":["take care","let go","stay away"],"answer":0},
  {"q":"Maura felt _______ that Tina always took charge of every project they did together.","choices":["excited","resentful","grateful"],"answer":1},
  {"q":"The _______ between Maura and Tina became tense when they disagreed about the talent show.","choices":["problem","situation","discussion"],"answer":1},
  {"q":"Maura _______ wanted to win, but she also wanted to do an act that was all her own.","choices":["calmly","quietly","desperately"],"answer":2},
  {"q":"Tina said her _______ came from a new TV show she had watched with her mom.","choices":["inspiration","reason","interest"],"answer":0},
  {"q":"Tina’s dance _______ required both practice and matching costumes.","choices":["story","routine","meeting"],"answer":1},
  {"q":"Grandma told Maura to _______ what she really wanted before talking to Tina again.","choices":["say","ignore","consider"],"answer":2},
  {"q":"Tina didn’t want to feel _______ if their act didn’t go well on stage.","choices":["humiliated","proud","respected"],"answer":0},
  {"q":"Grandma listened _______ to Maura as she explained her problem.","choices":["carefully","quickly","silently"],"answer":0},
  {"q":"Grandma said Maura should be _______ of her own ideas, even if Tina disagreed.","choices":["fearful","respectful","confused"],"answer":1},
  {"q":"Grandma reminded Maura that she was still _______ for her own actions.","choices":["thankful","hopeful","accountable"],"answer":2},
  {"q":"Grandma decided to _______ Maura to tell Tina the truth about her plans.","choices":["warn","remind","advise"],"answer":2},
  {"q":"Grandma said there were other ways to be a good friend _______ always doing what Tina wanted.","choices":["besides","without","before"],"answer":0},
  {"q":"Grandma said standing up for herself would be good for Maura’s _______.","choices":["self-esteem","happiness","confidence"],"answer":0},
  {"q":"When Maura finally called Tina, Tina’s short and _______ reply hurt her feelings.","choices":["kind","curt","cheerful"],"answer":1},
  {"q":"Maura couldn’t help but _______ that Tina might stay upset with her.","choices":["hope","worry","laugh"],"answer":1},
  {"q":"After the talent show, Maura wanted to _______ how proud she felt of her performance.","choices":["describe","forget","repeat"],"answer":0},
  {"q":"Maura was filled with _______ when Tina smiled at her after the show.","choices":["sadness","surprise","anger"],"answer":1},
  {"q":"In the end, Maura learned to _______ for herself and speak honestly about her ideas.","choices":["wait","stay quiet","stand up"],"answer":2}
];

/* ---------- Utility ---------- */
const $ = sel => document.querySelector(sel);
const app = document.getElementById("app");

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function pct(n,d){ return Math.round((n/d)*1000)/10; } // 1 decimal

/* ---------- State ---------- */
let studentName = "";
const sections = [
  { key:"vocab", title:"Vocabulary", data: shuffle(window.VOCAB_BANK) },
  { key:"comp",  title:"Comprehension", data: shuffle(window.COMP_BANK) },
  { key:"cloze", title:"Cloze", data: shuffle(window.CLOZE_BANK) }
];
let secIndex = 0;

/* ---------- Screens ---------- */
function renderStart(){
  $("#tab-vocab").disabled = true;
  $("#tab-comp").disabled = true;
  $("#tab-cloze").disabled = true;

  app.innerHTML = `
    <div class="start-screen">
      <h2 style="color:var(--stage-brown)">Enter Your Name to Begin</h2>
      <input id="nameInput" type="text" placeholder="Type your full name"/>
      <div>
        <button id="startBtn" class="next" disabled>Start Test</button>
      </div>
    </div>
  `;
  const nameInput = $("#nameInput");
  const startBtn = $("#startBtn");
  nameInput.addEventListener("input", () => {
    startBtn.disabled = nameInput.value.trim()==="";
  });
  startBtn.addEventListener("click", () => {
    studentName = nameInput.value.trim();
    secIndex = 0;
    sections.forEach(s => { s.correct = 0; s.i = 0; });
    renderQuiz();
  });
}

function setActiveTabs(){
  $("#tab-vocab").classList.toggle("active", secIndex===0);
  $("#tab-comp").classList.toggle("active", secIndex===1);
  $("#tab-cloze").classList.toggle("active", secIndex===2);
}

function renderQuiz(){
  setActiveTabs();
  const sec = sections[secIndex];
  const q = sec.data[sec.i];
  $("#tab-vocab").disabled = $("#tab-comp").disabled = $("#tab-cloze").disabled = true;

  app.innerHTML = `
    <div class="qa-card">
      <div class="section-title">${sec.title}</div>
      <div class="prompt">${q.q}</div>
      <div class="choices" id="choices"></div>
      <div class="actions">
        <button id="submitBtn" class="submit" disabled>Submit</button>
        <button id="nextBtn" class="next" style="display:none">${sec.i===sec.data.length-1 ? "Finish Section" : "Next"}</button>
      </div>
      <div class="counter">${sec.i+1} / ${sec.data.length}</div>
    </div>
  `;

  const choicesDiv = $("#choices");
  let selected = null;
  q.choices.forEach((c,idx)=>{
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.innerHTML = String.fromCharCode(65+idx)+". "+c;
    btn.addEventListener("click",()=>{
      if ($("#submitBtn").dataset.lock==="1") return;
      selected = idx;
      document.querySelectorAll(".choice").forEach(el=>el.classList.remove("selected"));
      btn.classList.add("selected");
      $("#submitBtn").disabled = (selected===null);
    });
    choicesDiv.appendChild(btn);
  });

  $("#submitBtn").addEventListener("click", ()=>{
    if (selected===null) return;
    $("#submitBtn").dataset.lock="1";
    // lock & mark
    const nodes = document.querySelectorAll(".choice");
    nodes.forEach((el,idx)=>{
      el.disabled = true;
      if (idx===q.answer) el.classList.add("correct");
      else if (idx===selected) el.classList.add("wrong");
    });
    if (selected===q.answer) sections[secIndex].correct = (sections[secIndex].correct||0)+1;
    $("#nextBtn").style.display = "inline-block";
  });

  $("#nextBtn").addEventListener("click", ()=>{
    const lastQ = sec.i===sec.data.length-1;
    if (!lastQ){
      sec.i += 1;
      renderQuiz();
    } else {
      // next section or results
      if (secIndex<sections.length-1){
        secIndex += 1;
        renderQuiz();
      } else {
        renderResults();
      }
    }
  });
}

function renderResults(){
  $("#tab-vocab").disabled = true;
  $("#tab-comp").disabled = true;
  $("#tab-cloze").disabled = true;

  const v = sections[0], c = sections[1], z = sections[2];
  const totalCorrect = (v.correct||0)+(c.correct||0)+(z.correct||0);
  const totalQs = v.data.length + c.data.length + z.data.length;
  const now = new Date().toLocaleString();

  app.innerHTML = `
    <div class="result-card">
      <h2>Final Results</h2>
      <p><strong>Student:</strong> ${studentName}</p>
      <table>
        <thead><tr><th>Section</th><th>Score</th><th>%</th></tr></thead>
        <tbody>
          <tr><td>Vocabulary</td><td>${v.correct||0} / ${v.data.length}</td><td>${pct(v.correct||0,v.data.length)}%</td></tr>
          <tr><td>Comprehension</td><td>${c.correct||0} / ${c.data.length}</td><td>${pct(c.correct||0,c.data.length)}%</td></tr>
          <tr><td>Cloze</td><td>${z.correct||0} / ${z.data.length}</td><td>${pct(z.correct||0,z.data.length)}%</td></tr>
          <tr><td><strong>Total</strong></td><td><strong>${totalCorrect} / ${totalQs}</strong></td><td><strong>${pct(totalCorrect,totalQs)}%</strong></td></tr>
        </tbody>
      </table>
      <div style="display:flex;gap:.6rem;justify-content:center">
        <button class="return" id="restartBtn">Return to Start</button>
        <button class="download" id="csvBtn">Download CSV</button>
      </div>
      <p style="margin-top:.6rem;color:#7a5b5b">Completed: ${now}</p>
    </div>
  `;

  $("#restartBtn").addEventListener("click", renderStart);
  $("#csvBtn").addEventListener("click", ()=>{
    const rows = [
      ["Name","Vocab Score","Vocab %","Comp Score","Comp %","Cloze Score","Cloze %","Total %","Completed"],
      [
        studentName,
        `${(v.correct||0)}/${v.data.length}`, pct(v.correct||0,v.data.length),
        `${(c.correct||0)}/${c.data.length}`, pct(c.correct||0,c.data.length),
        `${(z.correct||0)}/${z.data.length}`, pct(z.correct||0,z.data.length),
        pct((v.correct||0)+(c.correct||0)+(z.correct||0), v.data.length+c.data.length+z.data.length),
        now
      ]
    ];
    const csv = rows.map(r=>r.join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "talent-show-results.csv";
    a.click();
    URL.revokeObjectURL(url);
  });
}

/* ---------- init ---------- */
renderStart();
